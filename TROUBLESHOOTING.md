# 故障排除指南

## ERR_ADDRESS_UNREACHABLE 錯誤

### 錯誤說明

當前端嘗試連接到後端伺服器時出現 `ERR_ADDRESS_UNREACHABLE` 錯誤，表示：

- 前端無法到達指定的 IP 地址和端口
- 網路連接被阻擋或伺服器未正確運行

### 常見原因

1. **後端伺服器未啟動**
   - 最常見的原因
   - 伺服器進程可能已停止或從未啟動

2. **伺服器監聽地址錯誤**
   - 伺服器只監聽在 `127.0.0.1`（localhost）而不是 `0.0.0.0`
   - 這會導致外部設備無法連接

3. **防火牆阻擋**
   - 系統防火牆或路由器防火牆阻擋了端口 4000
   - 需要開放端口或添加例外規則

4. **IP 地址不正確**
   - 前端使用的 IP 地址與後端實際 IP 不符
   - 網路配置變更導致 IP 地址改變

5. **網路連接問題**
   - 前端和後端不在同一網路
   - 網路路由問題

### 診斷步驟

#### 1. 使用診斷工具

執行診斷腳本檢查連接問題：

```bash
# 使用預設 IP (192.168.2.7:4000)
npm run diagnose

# 或指定 IP 和端口
node scripts/diagnoseConnection.js 192.168.2.7 4000
```

診斷工具會檢查：
- 本機網路介面
- 伺服器進程狀態
- 本地連接測試
- 目標 IP 連接測試

#### 2. 手動檢查伺服器狀態

**檢查伺服器是否運行：**

```bash
# macOS/Linux
lsof -i :4000

# Windows
netstat -ano | findstr :4000
```

如果沒有輸出，表示伺服器未運行。

**啟動伺服器：**

```bash
# 開發模式（自動重啟）
npm run dev

# 正式模式
npm start
```

#### 3. 檢查伺服器配置

確認 `.env` 文件中的配置：

```env
HOST=0.0.0.0    # 必須是 0.0.0.0 才能接受外部連接
PORT=4000       # 確認端口號正確
```

**重要**：`HOST=0.0.0.0` 允許伺服器接受來自任何網路介面的連接。如果設為 `127.0.0.1` 或 `localhost`，只有本機可以連接。

#### 4. 檢查本機 IP 地址

伺服器啟動時會顯示本機 IP 地址：

```
🚀 BA 系統後端服務已啟動，監聽 0.0.0.0:4000
📍 本機連線: http://localhost:4000
📍 區域網路連線: http://192.168.2.7:4000
```

確認前端使用的 IP 地址與此一致。

#### 5. 測試本地連接

在後端伺服器上測試本地連接：

```bash
# 測試本地 API
curl http://localhost:4000/api/users/login

# 測試本機 IP
curl http://192.168.2.7:4000/api/users/login
```

如果本地連接成功但外部連接失敗，可能是防火牆問題。

#### 6. 檢查防火牆設置

**macOS:**

```bash
# 檢查防火牆狀態
sudo /usr/libexec/ApplicationFirewall/socketfilterfw --getglobalstate

# 允許 Node.js 通過防火牆
sudo /usr/libexec/ApplicationFirewall/socketfilterfw --add /usr/local/bin/node
sudo /usr/libexec/ApplicationFirewall/socketfilterfw --unblockapp /usr/local/bin/node
```

**Linux (ufw):**

```bash
# 開放端口 4000
sudo ufw allow 4000/tcp
sudo ufw reload
```

**Windows:**

1. 開啟「Windows Defender 防火牆」
2. 點擊「進階設定」
3. 新增「輸入規則」
4. 允許端口 4000 的 TCP 連接

#### 7. 檢查 CORS 設定

確認 `CORS_ORIGINS` 環境變數包含前端地址：

```env
CORS_ORIGINS=http://localhost:3000,http://192.168.2.7:3000
```

或使用 `*` 允許所有來源（僅用於開發）：

```env
CORS_ORIGINS=*
```

### 解決方案

#### 方案 1: 確認伺服器正在運行

```bash
# 啟動伺服器
npm run dev

# 確認輸出顯示正確的 IP 和端口
# 應該看到類似：
# 🚀 BA 系統後端服務已啟動，監聽 0.0.0.0:4000
# 📍 區域網路連線: http://192.168.2.7:4000
```

#### 方案 2: 修正伺服器監聽地址

創建或修改 `.env` 文件：

```env
HOST=0.0.0.0
PORT=4000
```

然後重啟伺服器。

#### 方案 3: 檢查並更新前端配置

確認前端環境變數 `NUXT_PUBLIC_API_BASE` 指向正確的後端地址：

```env
NUXT_PUBLIC_API_BASE=http://192.168.2.7:4000
```

#### 方案 4: 使用正確的 IP 地址

如果 IP 地址已變更，更新前端配置：

1. 在後端伺服器上執行診斷工具查看實際 IP
2. 更新前端的 `NUXT_PUBLIC_API_BASE` 環境變數
3. 重啟前端應用

#### 方案 5: 檢查網路連接

確認前端和後端在同一網路：

```bash
# 從前端設備 ping 後端
ping 192.168.2.7

# 測試端口連接
telnet 192.168.2.7 4000
# 或使用 nc (netcat)
nc -zv 192.168.2.7 4000
```

### 快速檢查清單

- [ ] 後端伺服器正在運行
- [ ] `.env` 文件中 `HOST=0.0.0.0`
- [ ] `.env` 文件中 `PORT=4000`
- [ ] 伺服器啟動日誌顯示正確的 IP 地址
- [ ] 前端 `NUXT_PUBLIC_API_BASE` 指向正確的後端地址
- [ ] 防火牆允許端口 4000
- [ ] 前端和後端在同一網路
- [ ] 可以從前端設備 ping 通後端 IP
- [ ] CORS 設定包含前端地址

### 其他常見問題

#### 問題：伺服器啟動但無法連接

**可能原因：**
- 伺服器監聽在 `127.0.0.1` 而不是 `0.0.0.0`
- 防火牆阻擋

**解決方法：**
1. 檢查 `.env` 中的 `HOST` 設定
2. 檢查防火牆規則

#### 問題：連接超時

**可能原因：**
- 網路延遲過高
- 防火牆阻擋但未立即拒絕

**解決方法：**
1. 檢查網路連接品質
2. 確認防火牆設定
3. 增加請求超時時間（前端設定）

#### 問題：CORS 錯誤

**可能原因：**
- `CORS_ORIGINS` 未包含前端地址

**解決方法：**
更新 `.env` 中的 `CORS_ORIGINS` 設定。

### 需要更多幫助？

如果以上步驟都無法解決問題，請提供以下資訊：

1. 診斷工具輸出結果
2. 伺服器啟動日誌
3. 前端錯誤訊息完整內容
4. 作業系統版本
5. 網路配置資訊

